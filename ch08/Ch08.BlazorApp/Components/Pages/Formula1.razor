@page "/formula1"
@using Ch08.DataLib
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Ch08.BlazorApp.Components.Formula1
@inject IFormula1Repository Repository
@inject IServiceProvider ServiceProvider
@rendermode InteractiveServer

<PageTitle>Formula 1 Data Queries</PageTitle>

<h1>Formula 1 Data Queries</h1>

<p>This page demonstrates Entity Framework Core queries with SQL generation display.</p>

<div class="row">
    <QueryOptions 
        SelectedQueryType="@selectedQueryType"
        SelectedQueryTypeChanged="@OnQueryTypeChanged"
        CountryFilter="@countryFilter"
        CountryFilterChanged="@((value) => { countryFilter = value; })"
        MinWinsFilter="@minWinsFilter"
        MinWinsFilterChanged="@((value) => { minWinsFilter = value; })"
        OnExecuteQuery="@ExecuteQuery" />
    
    <SqlDisplay Sql="@generatedSql" />
</div>

<div class="row mt-4">
    <div class="col-12">
        <h3>Query Results</h3>
        @if (isLoading)
        {
            <LoadingSpinner />
        }
        else if (queryResults != null)
        {
            <div class="table-responsive">
                @if (selectedQueryType == "allRacers" || selectedQueryType == "racersByCountry" || selectedQueryType == "racersWithMinWins")
                {
                    <RacersTable Racers="((IEnumerable<Racer>)queryResults)" />
                }
                else if (selectedQueryType == "allTeams")
                {
                    <TeamsTable Teams="((IEnumerable<Team>)queryResults)" />
                }
                else
                {
                    <JsonResults Data="queryResults" />
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                @errorMessage
            </div>
        }
    </div>
</div>

@code {
    private string selectedQueryType = "allRacers";
    private string countryFilter = "United Kingdom";
    private int minWinsFilter = 10;
    private object? queryResults;
    private string generatedSql = "";
    private bool isLoading = false;
    private string errorMessage = "";

    private void OnQueryTypeChanged(string value)
    {
        selectedQueryType = value;
        queryResults = null;
        generatedSql = "";
        errorMessage = "";
    }

    private async Task ExecuteQuery()
    {
        isLoading = true;
        errorMessage = "";
        queryResults = null;
        generatedSql = "";
        StateHasChanged();

        try
        {
            switch (selectedQueryType)
            {
                case "allRacers":
                    queryResults = await Repository.GetRacersAsync();
                    break;
                case "allTeams":
                    queryResults = await Repository.GetTeamsAsync();
                    break;
                case "racersByCountry":
                    queryResults = await Repository.GetRacersByCountryAsync(countryFilter);
                    break;
                case "racersWithMinWins":
                    queryResults = await Repository.GetRacersWithMostWinsAsync(minWinsFilter);
                    break;
                case "racersGroupedByCountry":
                    queryResults = await Repository.GetRacersGroupedByCountryAsync();
                    break;
                case "teamsWithRacerCount":
                    queryResults = await Repository.GetTeamsWithRacerCountAsync();
                    break;
            }

            generatedSql = Repository.GetLastExecutedSql();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error executing query: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}